{% extends 'game/base.html' %}
{% load static %}
{% block content %}
<style>
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
.fade-in {
    animation: fadeIn 0.8s ease-out;
}
@keyframes bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

 

#catButton:active img {
    animation: bounce 0.2s ease;
}
</style>

<div class="container mx-auto text-center mt-10">
    <h1 class="text-4xl font-bold text-pink-700 mb-6">üêæ Cat Clicker</h1>

    <div class="flex justify-center mb-4 space-x-4">
        {% for c in cats %}
        <a href="{% url 'index_with_cat' c.id %}" 
           class="px-4 py-2 rounded-lg {% if cat and c.id == cat.id %}bg-pink-500 text-white{% else %}bg-gray-200 hover:bg-pink-100{% endif %}">
           {{ c.name }}
        </a>
        {% endfor %}
    </div>

    {% if cat %}
    <div class="bg-white rounded-xl shadow-lg p-6 w-96 mx-auto">
        <h2 class="text-3xl font-semibold text-gray-800 mb-2">{{ cat.name }}</h2>
        <p class="text-gray-600 mb-2">–£—Ä–æ–≤–µ–Ω—å: {{ cat.level }}</p>
        <p id="catMilk" class="text-gray-600 mb-4">–ú–æ–ª–æ–∫–æ: üçº {{ cat.milk|default:0 }}</p>


        <form id="clickForm" action="{% url 'click_cat' cat.id %}" method="post">
            {% csrf_token %}
            <button type="button" id="catButton"
                class="px-6 py-3 rounded-full bg-gradient-to-r from-pink-400 via-purple-500 to-blue-500 
                       text-white font-bold text-xl shadow-lg transform transition duration-300 hover:scale-110 
                       hover:shadow-2xl active:scale-95 focus:outline-none">
                üê± Click me!
            </button>
        </form>

        

        <script>
/* helper: –ø–æ–ª—É—á–∏—Ç—å csrftoken –∏–∑ cookie */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');
const catName = "{{ cat.name|default:'–ö–æ—Ç' }}";
let catMilk = {{ cat.milk|default:0 }};
const catMilkElem = document.getElementById('catMilk'); // –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ DOM
const clickSound = document.getElementById('clickSound');
const catButton = document.getElementById('catButton');

if (!catMilkElem) {
    console.warn('catMilk element not found ‚Äî —É–±–µ–¥–∏—Å—å, —á—Ç–æ <p id="catMilk"> –µ—Å—Ç—å –≤ —à–∞–±–ª–æ–Ω–µ');
}

catButton.addEventListener('click', function(event) {
    event.preventDefault();

    // –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∑–≤—É–∫ –∫–ª–∏–∫–∞ (–∫–∞–∂–¥—ã–π –∫–ª–∏–∫)
    if (clickSound) {
        clickSound.currentTime = 0;
        clickSound.play().catch(err => console.log('play error:', err));
    }

    fetch("{% url 'click_cat' cat.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ action: 'click' })
    })
    .then(response => {
        if (!response.ok) throw new Error('network response not ok: ' + response.status);
        return response.json();
    })
    .then(data => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏
        if (data.score !== undefined) {
            document.querySelector('.score').textContent = `–û—á–∫–∏: ${data.score}`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–ª–æ–∫–æ ‚Äî —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (data.milk !== undefined && catMilkElem) {
            catMilk = data.milk;
            catMilkElem.textContent = `–ú–æ–ª–æ–∫–æ: üçº ${catMilk}`;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—É–±–∏—Ä–∞–µ–º –≥–∏—Ñ–∫—É —Å—á–∞—Å—Ç—å—è (–ø–æ—è–≤–ª—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ score –∫—Ä–∞—Ç–µ–Ω 20)
        // üéâ –Æ–±–∏–ª–µ–π–Ω—ã–π –∫–ª–∏–∫ (–∫–∞–∂–¥—ã–µ 20)
const existingGif = document.getElementById('happyCat');
if (data.score % 20 === 0) {
    // –ì–∏—Ñ–∫–∞
    if (!existingGif) {
        const newDiv = document.createElement('div');
        newDiv.id = 'happyCat';
        newDiv.className = 'mt-6 fade-in';
        newDiv.innerHTML = `
            <img src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif"
                 alt="happy cat"
                 class="mx-auto w-60 rounded-xl shadow-lg">
            <p class="text-pink-600 font-bold mt-2 text-xl">–£—Ä–∞! ${catName} —Å—á–∞—Å—Ç–ª–∏–≤ üòª</p>
        `;
        document.querySelector('.score').before(newDiv);

      
       

        // üéµ –ó–≤—É–∫ —Ç–æ–ª—å–∫–æ —Ç—É—Ç
        if (clickSound) {
            clickSound.currentTime = 0;
            clickSound.play().catch(err => console.log('–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:', err));
        }

        // üéä –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ —ç—Ñ—Ñ–µ–∫—Ç
        createConfetti();
    }
} else if (existingGif) {
    existingGif.remove();
}

// üéä –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
function createConfetti() {
    const duration = 2 * 1000;
    const end = Date.now() + duration;

    (function frame() {
        // —Å–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã
        const confetti = document.createElement('div');
        confetti.textContent = 'üéâ';
        confetti.style.position = 'fixed';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.top = '-10px';
        confetti.style.fontSize = '24px';
        confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear`;
        document.body.appendChild(confetti);

        setTimeout(() => confetti.remove(), 4000);
        if (Date.now() < end) requestAnimationFrame(frame);
    })();
}

    })
    .catch(err => {
        console.error('–û—à–∏–±–∫–∞ AJAX:', err);
    });
});
</script>


        {% if cat.score is defined and cat.score >= 20 and cat.score|divisibleby:20 %}
        <div id="happyCat" class="mt-6 fade-in">
            <img src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif"
                 alt="happy cat"
                 class="mx-auto w-60 rounded-xl shadow-lg">
            <p class="text-pink-600 font-bold mt-2 text-xl">–£—Ä–∞! {{ cat.name|default:'–ö–æ—Ç' }} —Å—á–∞—Å—Ç–ª–∏–≤ üòª</p>
        </div>
        {% endif %}
        <p class="text-xl font-bold mt-4 score">–û—á–∫–∏: {{ cat.score|default:0 }}</p>
    </div>

    {% else %}
    <p class="text-gray-500 text-lg">–í—ã–±–µ—Ä–∏ –∫–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É üò∫</p>
    {% endif %}
</div>
{% endblock %}
