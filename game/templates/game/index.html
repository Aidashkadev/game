{% extends 'game/base.html' %}
{% load static %}
{% block content %}
<style>
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
.fade-in {
    animation: fadeIn 0.8s ease-out;
}
@keyframes bounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
#catButton:active img {
    animation: bounce 0.2s ease;
}
</style>

<div class="container mx-auto text-center mt-10">
    <h1 class="text-4xl font-bold text-pink-700 mb-6">üêæ Cat Clicker</h1>

    <!-- –í—ã–±–æ—Ä –∫–æ—Ç–∞ -->
    <div class="flex justify-center mb-4 space-x-4">
        {% for c in cats %}
        <a href="{% url 'index_with_cat' c.id %}" 
           class="px-4 py-2 rounded-lg {% if cat and c.id == cat.id %}bg-pink-500 text-white{% else %}bg-gray-200 hover:bg-pink-100{% endif %}">
           {{ c.name }}
        </a>
        {% endfor %}
    </div>

    <!-- –ï—Å–ª–∏ –∫–æ—Ç –≤—ã–±—Ä–∞–Ω -->
    {% if cat %}
    <div class="bg-white rounded-xl shadow-lg p-6 w-96 mx-auto">
        <h2 class="text-3xl font-semibold text-gray-800 mb-2">{{ cat.name }}</h2>
        <p class="text-gray-600 mb-2">–£—Ä–æ–≤–µ–Ω—å: {{ cat.level }}</p>
        <p class="text-gray-600 mb-4">–ú–æ–ª–æ–∫–æ: üçº {{ cat.milk }}</p>

        <form id="clickForm" action="{% url 'click_cat' cat.id %}" method="post">
            {% csrf_token %}
           <button type="button" id="catButton"
        class="px-6 py-3 rounded-full bg-gradient-to-r from-pink-400 via-purple-500 to-blue-500 
               text-white font-bold text-xl shadow-lg transform transition duration-300 hover:scale-110 
               hover:shadow-2xl active:scale-95 focus:outline-none">
    üê± Click me!
</button>

        </form>

        <!-- üéµ –ó–≤—É–∫ –∫–ª–∏–∫–∞ -->
        <audio id="clickSound" src="{% static 'game/sounds/cat-meow-8-fx-306184.mp3' %}"></audio>

        <!-- JavaScript-–∫–æ–¥ -->
        <script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');


            
        document.getElementById('catButton').addEventListener('click', function(event) {
            event.preventDefault();

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞
            const sound = document.getElementById('clickSound');
            if (sound) {
                console.log('–ê—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, URL:', sound.src);
                console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É–¥–∏–æ:', sound.readyState, sound.paused);
                sound.currentTime = 0;
                sound.play().catch(function(error) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error.message);
                    console.error('URL –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞:', sound.src);
                });
            } else {
                console.error('–≠–ª–µ–º–µ–Ω—Ç <audio> —Å id="clickSound" –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }

            // AJAX-–∑–∞–ø—Ä–æ—Å
            fetch("{% url 'click_cat' cat.id %}", {
                method: 'POST',
                headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': csrftoken,
},

                body: JSON.stringify({ action: 'click' })
            })
            .then(response => {
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                if (!response.ok) {
                    throw new Error('–°–µ—Ç–µ–≤–æ–π –æ—Ç–≤–µ—Ç –Ω–µ OK: ' + response.status);
                }
                return response.text();
            })
            .then(text => {
                console.log('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', text);
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e.message, '–¢–µ–∫—Å—Ç:', text);
                    throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ' + text);
                }
                console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.score !== undefined) {
                    document.querySelector('.score').textContent = `–û—á–∫–∏: ${data.score}`;
                    if (data.score >= 20 && data.score % 20 === 0) {
                        const happyCatDiv = document.getElementById('happyCat');
                        if (!happyCatDiv) {
                            const newDiv = document.createElement('div');
                            newDiv.id = 'happyCat';
                            newDiv.className = 'mt-6 fade-in';
                            newDiv.innerHTML = `
                                <img src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif"
                                     alt="happy cat"
                                     class="mx-auto w-60 rounded-xl shadow-lg">
                                <p class="text-pink-600 font-bold mt-2 text-xl">–£—Ä–∞! {{ cat.name|default:'–ö–æ—Ç' }} —Å—á–∞—Å—Ç–ª–∏–≤ üòª</p>
                            `;
                            document.querySelector('.score').before(newDiv);
                        }
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞: score –Ω–µ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –æ—Ç–≤–µ—Ç–µ', data);
                    // –†–µ–∑–µ—Ä–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    fetch("{% url 'index_with_cat' cat.id %}")
                    .then(resp => resp.json())
                    .then(catData => {
                        if (catData.score !== undefined) {
                            document.querySelector('.score').textContent = `–û—á–∫–∏: ${catData.score}`;
                        }
                    });
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ AJAX:', error.message));
        });
        </script>

        {% if cat.score is defined and cat.score >= 20 and cat.score|divisibleby:20 %}
        <div id="happyCat" class="mt-6 fade-in">
            <img src="https://media.giphy.com/media/MDJ9IbxxvDUQM/giphy.gif"
                 alt="happy cat"
                 class="mx-auto w-60 rounded-xl shadow-lg">
            <p class="text-pink-600 font-bold mt-2 text-xl">–£—Ä–∞! {{ cat.name|default:'–ö–æ—Ç' }} —Å—á–∞—Å—Ç–ª–∏–≤ üòª</p>
        </div>
        {% endif %}
        <p class="text-xl font-bold mt-4 score">–û—á–∫–∏: {{ cat.score|default:0 }}</p>
    </div>

    {% else %}
    <p class="text-gray-500 text-lg">–í—ã–±–µ—Ä–∏ –∫–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É üò∫</p>
    {% endif %}
</div>
{% endblock %}